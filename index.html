<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í–∏–≤–∏ (V4.5unit) - –í–∞—à –ò–ò –ö–æ–º–ø–∞–Ω—å–æ–Ω</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å—Ç–∏–ª–∏ –∏ –∏–º–ø–æ—Ä—Ç —à—Ä–∏—Ñ—Ç–∞ Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
            color: #e0e0e0;
            display: flex;
            gap: 1rem;
            min-height: 100vh;
            padding: 1rem;
            box-sizing: border-box;
            overflow: hidden;
        }
        
        .sidebar {
            width: 380px;  /* –ë—ã–ª–æ 350px, —É–≤–µ–ª–∏—á–µ–Ω–æ –µ—â—ë –Ω–∞ 30px */
            background-color: #1a1a2e;
            border-radius: 1.5rem;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            overflow-y: auto;
            flex-shrink: 0;
        }
        
        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .sidebar-title {
            font-size: 1.35rem;  /* –ë—ã–ª–æ 1.3rem */
            font-weight: 700;
            color: #e94560;
            letter-spacing: 0.05em;
        }
        
        .sidebar-button {
            background: none;
            border: none;
            color: #e0e0e0;
            cursor: pointer;
            font-size: 1.2rem;
            transition: color 0.3s ease;
            padding: 0.3rem;
        }
        
        .sidebar-button:hover {
            color: #e94560;
        }
        
        .new-chat-button {
            background-color: #e94560;
            color: white;
            border: none;
            border-radius: 0.8rem;
            padding: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .new-chat-button:hover {
            background-color: #b7384d;
        }
        
        .chat-list {
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .chat-item {
            background-color: #2a2a4a;
            border-radius: 0.8rem;
            padding: 1.15rem;  /* –ë—ã–ª–æ 1.1rem */
            cursor: pointer;
            transition: background-color 0.3s ease, border-color 0.3s ease;
            border: 1px solid transparent;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 0.5rem;
        }
        
        .chat-item:hover {
            background-color: #16213e;
            border-color: #e94560;
        }
        
        .chat-item.active {
            background-color: #0f3460;
            border-color: #e94560;
        }
        
        .chat-item-content {
            flex-grow: 1;
            overflow: hidden;
        }
        
        .chat-item-title {
            font-weight: 600;
            color: #e0e0e0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.96rem;  /* –ë—ã–ª–æ 0.95rem */
        }
        
        .chat-item-preview {
            font-size: 0.89rem;  /* –ë—ã–ª–æ 0.88rem */
            color: #a0a0a0;
            margin-top: 0.3rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .chat-item-time {
            font-size: 0.75rem;
            color: #707070;
            white-space: nowrap;
        }
        
        .chat-item-delete {
            background: none;
            border: none;
            color: #a0a0a0;
            cursor: pointer;
            font-size: 0.9rem;
            padding: 0.2rem;
            opacity: 0;
            transition: opacity 0.3s ease, color 0.3s ease;
        }
        
        .chat-item:hover .chat-item-delete {
            opacity: 1;
        }
        
        .chat-item-delete:hover {
            color: #e94560;
        }
        
        .sidebar-footer {
            border-top: 1px solid #0f3460;
            padding-top: 1rem;
            display: flex;
            gap: 0.5rem;
        }
        
        .sidebar-footer button {
            flex: 1;
            background-color: #2a2a4a;
            color: #e0e0e0;
            border: 1px solid #0f3460;
            border-radius: 0.6rem;
            padding: 0.6rem;
            font-size: 0.85rem;
            cursor: pointer;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        
        .sidebar-footer button:hover {
            background-color: #16213e;
            border-color: #e94560;
            color: #e94560;
        }
        
        .main-content {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .vivi-container {
            background-color: #2a2a4a;
            border-radius: 1.5rem;
            padding: 2.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            max-width: 900px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            max-height: 95vh;
        }
        .chat-history {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 0.5rem; /* –î–ª—è –ø–æ–ª–æ—Å—ã –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ */
            display: flex;
            flex-direction: column;
            gap: 1rem; /* –ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ */
        }
        .message-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 0.5rem;
        }
        .user-message-wrapper {
            justify-content: flex-end;
        }
        .vivi-message-wrapper {
            justify-content: flex-start;
        }
        .message-bubble {
            max-width: 85%;
            padding: 0.8rem 1.2rem; /* –£–≤–µ–ª–∏—á–∏—Ç—å –æ—Ç—Å—Ç—É–ø—ã */
            border-radius: 1.2rem; /* –ë–æ–ª–µ–µ —Å–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–µ —É–≥–ª—ã */
            line-height: 1.5;
            word-wrap: break-word;
            white-space: pre-wrap; /* –°–æ—Ö—Ä–∞–Ω—è—Ç—å –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ */
            position: relative; /* –î–ª—è –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π */
        }
        .user-message {
            background-color: #0f3460; /* –ë–æ–ª–µ–µ —Ç–µ–º–Ω—ã–π —Å–∏–Ω–∏–π */
            border-bottom-right-radius: 0.3rem; /* "–û—Å—Ç—Ä—ã–π" —É–≥–æ–ª */
        }
        .vivi-message {
            background-color: #16213e; /* –ù–µ–º–Ω–æ–≥–æ –±–æ–ª–µ–µ —Å–≤–µ—Ç–ª—ã–π —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π */
            border-bottom-left-radius: 0.3rem; /* "–û—Å—Ç—Ä—ã–π" —É–≥–æ–ª */
        }
        .message-actions {
            display: flex;
            gap: 0.3rem;
            margin-bottom: 0.2rem;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .message-wrapper:hover .message-actions {
            opacity: 1;
        }
        .message-actions button {
            background: none;
            border: none;
            color: #e0e0e0;
            cursor: pointer;
            font-size: 0.8em;
            padding: 0.2rem;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }
        .message-actions button:hover {
            opacity: 1;
            color: #e94560;
        }
        .copied-message {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #e94560;
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            white-space: nowrap;
            pointer-events: none;
        }
        .input-area {
            display: flex;
            gap: 0.8rem; /* –ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –º–µ–∂–¥—É –ø–æ–ª–µ–º –≤–≤–æ–¥–∞ –∏ –∫–Ω–æ–ø–∫–∞–º–∏ */
            align-items: flex-end; /* –í—ã—Ä–æ–≤–Ω—è—Ç—å –∫–Ω–æ–ø–∫–∏ –ø–æ –Ω–∏–∑—É —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—è */
        }
        .input-area textarea {
            flex-grow: 1;
            background-color: #1a1a2e;
            border: 1px solid #0f3460;
            border-radius: 0.8rem;
            padding: 0.8rem 1rem;
            color: #e0e0e0;
            resize: none; /* –û—Ç–∫–ª—é—á–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º */
            min-height: 40px; /* –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ */
            max-height: 150px; /* –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ */
            overflow-y: auto;
        }
        .input-area button {
            background-color: #e94560; /* –Ø—Ä–∫–∏–π –∞–∫—Ü–µ–Ω—Ç–Ω—ã–π —Ü–≤–µ—Ç */
            color: white;
            border-radius: 0.8rem;
            padding: 0.8rem 1.2rem;
            font-weight: 600;
            transition: background-color 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 40px; /* –î–ª—è –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ */
            min-height: 40px;
        }
        .input-area button:hover:not(:disabled) {
            background-color: #b7384d;
        }
        .input-area button:disabled {
            background-color: #554a55; /* –°–µ—Ä—ã–π –¥–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ */
            cursor: not-allowed;
        }
        .header {
            text-align: center;
            font-size: 2.2rem; /* –£–≤–µ–ª–∏—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä –∑–∞–≥–æ–ª–æ–≤–∫–∞ */
            font-weight: 700;
            color: #e94560; /* –¶–≤–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∞ */
            margin-bottom: 1rem;
            letter-spacing: 0.05em; /* –ù–µ–±–æ–ª—å—à–æ–π –º–µ–∂–±—É–∫–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª */
        }
        .logo-small {
            width: 30px;
            height: 30px;
            margin-right: 8px;
            vertical-align: middle;
        }
        .loading-indicator {
            display: none; /* –°–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
            text-align: center;
            padding: 1rem;
            color: #e94560;
            font-weight: 600;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–µ–¥–∏–∞ –∏ –∫–æ–¥–∞ –≤–Ω—É—Ç—Ä–∏ –ø—É–∑—ã—Ä—å–∫–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π */
        .message-bubble .generated-image,
        .message-bubble .uploaded-media {
            max-width: 100%;
            height: auto;
            display: block; /* –£–±—Ä–∞—Ç—å –ª–∏—à–Ω–µ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –ø–æ–¥ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º */
            margin-top: 0.5rem; /* –í–µ—Ä—Ö–Ω–∏–π –æ—Ç—Å—Ç—É–ø */
            border-radius: 0.5rem; /* –ù–µ–º–Ω–æ–≥–æ —Å–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–µ —É–≥–ª—ã */
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); /* –¢–µ–Ω—å –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è */
        }
        .message-bubble .code-display {
            background-color: #1a1a2e; /* –¢–µ–º–Ω—ã–π —Ñ–æ–Ω –¥–ª—è –∫–æ–¥–∞ */
            color: #00ff00; /* –ó–µ–ª–µ–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –∫–æ–¥–∞ */
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-top: 0.5rem;
            font-family: 'Fira Code', 'Consolas', 'monospace'; /* –ú–æ–Ω–æ—à–∏—Ä–∏–Ω–Ω—ã–π —à—Ä–∏—Ñ—Ç */
            white-space: pre-wrap; /* –°–æ—Ö—Ä–∞–Ω—è—Ç—å –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ */
            overflow-x: auto; /* –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫ */
            border: 1px solid #0f3460;
        }
        /* –ö–æ–Ω–µ—Ü –Ω–æ–≤—ã—Ö —Å—Ç–∏–ª–µ–π */
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
    <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –∏—Å—Ç–æ—Ä–∏–µ–π —á–∞—Ç–æ–≤ -->
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">üí¨ –ß–∞—Ç—ã</div>
            <button class="sidebar-button" id="toggle-sidebar" title="–°–≤–µ—Ä–Ω—É—Ç—å">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>
        
        <!-- –≠–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è: –ø–æ–∏—Å–∫, –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ, —ç–∫—Å–ø–æ—Ä—Ç -->
        <div class="sidebar-search" style="display:flex;gap:0.5rem;align-items:center;">
            <input id="chat-search-input" placeholder="–ü–æ–∏—Å–∫ –≤ —á–∞—Ç–µ..." style="flex:1;padding:0.5rem;border-radius:0.6rem;border:1px solid #0f3460;background:#121225;color:#e0e0e0;">
            <button id="search-clear-button" title="–û—á–∏—Å—Ç–∏—Ç—å –ø–æ–∏—Å–∫" class="sidebar-button" style="font-size:1rem;">‚úñ</button>
        </div>
        <div id="pinned-area" style="margin-top:0.75rem;">
            <div style="font-size:0.85rem;color:#a0a0a0;margin-bottom:0.4rem;">üìå –ó–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ</div>
            <div id="pinned-list"></div>
        </div>
        
        <button class="new-chat-button" id="new-chat-button">
            <i class="fas fa-plus"></i> –ù–æ–≤—ã–π —á–∞—Ç
        </button>
        
        <div class="chat-list" id="chat-list"></div>
        
        <div class="sidebar-footer">
            <button id="export-current-button" title="–≠–∫—Å–ø–æ—Ä—Ç —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞">
                <i class="fas fa-file-export"></i> –≠–∫—Å–ø–æ—Ä—Ç —á–∞—Ç–∞
            </button>
            <button id="rename-chat-button" title="–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å —á–∞—Ç">
                <i class="fas fa-edit"></i> –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å
            </button>
            <button id="clear-history-button" title="–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é">
                <i class="fas fa-trash"></i> –û—á–∏—Å—Ç–∏—Ç—å
            </button>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç -->
    <div class="main-content">
        <div class="vivi-container">
            <div class="header">
                <img src="https://raw.githubusercontent.com/ViOne-AI/Vivi/main/media/vivi_logo.png" alt="–õ–æ–≥–æ—Ç–∏–ø –í–∏–≤–∏" class="logo-small">
                –í–∏–≤–∏ (V4.5unit)
            </div>

            <div class="chat-history" id="chat-history">
                <div class="message-wrapper vivi-message-wrapper">
                    <div class="message-bubble vivi-message">–ü—Ä–∏–≤–µ—Ç! –Ø –í–∏–≤–∏, –≤–∞—à –ò–ò-–∫–æ–º–ø–∞–Ω—å–æ–Ω. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å? üòä</div>
                </div>
            </div>

            <div class="loading-indicator" id="loading-indicator">
                –í–∏–≤–∏ –¥—É–º–∞–µ—Ç... ü§î
            </div>

            <div class="input-area">
                <textarea
                    id="user-input"
                    placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –í–∏–≤–∏..."
                    rows="1"
                ></textarea>
                <button id="attach-button" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª">
                    <i class="fas fa-paperclip"></i>
                </button>
                <input type="file" id="hidden-file-input" style="display: none;">
                <button id="send-button" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ">
                    <i class="fas fa-paper-plane"></i>
                </button>
                <button id="speak-last-button" disabled title="–û–∑–≤—É—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç–≤–µ—Ç">
                    <i class="fas fa-volume-up"></i>
                </button>
            </div>
        </div>
    </div>

    <script> 
        // –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ —Å–≤–æ–π –≤–Ω–µ—à–Ω–∏–π IP –∏ –ø–æ—Ä—Ç 5000
        const VIVI_BACKEND_URL = "http://5.34.33.158:5000";
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let allChats = {};
        let chatHistoryArray = [];
        let currentChatId = null;
        let messageCounter = 0;
        let lastViviResponseText = '';

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        // –£–ë–†–ê–ù–ê –ø—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è:
        // loadChatsFromLocalStorage();
        // createNewChat();
        // renderChatList();

        // –ù–æ–≤—ã–µ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
        let messagesById = {}; // { messageId: { sender, content, type, fileData, filename, timestamp } }

        // –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —á–∞—Ç–∞–º–∏
        function generateChatId() {
            return 'chat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function createNewChat() {
            currentChatId = generateChatId();
            chatHistoryArray = [
                { role: "vivi", content: "–ü—Ä–∏–≤–µ—Ç! –Ø –í–∏–≤–∏, –≤–∞—à –ò–ò-–∫–æ–º–ø–∞–Ω—å–æ–Ω. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å? üòä" }
            ];
            allChats[currentChatId] = {
                messages: [...chatHistoryArray],
                title: '–ù–æ–≤—ã–π —á–∞—Ç',
                timestamp: new Date().getTime()
            };
            messageCounter = 0;
            lastViviResponseText = '';
            
            // –û—á–∏—â–∞–µ–º UI
            chatHistory.innerHTML = '';
            userInput.value = '';
            addMessage('vivi', "–ü—Ä–∏–≤–µ—Ç! –Ø –í–∏–≤–∏, –≤–∞—à –ò–ò-–∫–æ–º–ø–∞–Ω—å–æ–Ω. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å? üòä");
            
            saveChatsToLocalStorage();
            renderChatList();
            updateSendButtonState();
        }

        function loadChat(chatId) {
            if (!allChats[chatId]) return;
            
            currentChatId = chatId;
            const chat = allChats[chatId];
            chatHistoryArray = [...chat.messages];
            messageCounter = 0;
            lastViviResponseText = '';
            
            // –û—á–∏—â–∞–µ–º –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º UI
            chatHistory.innerHTML = '';
            chatHistoryArray.forEach(msg => {
                addMessage(msg.role, msg.content);
            });
            
            userInput.value = '';
            updateSendButtonState();
            renderChatList();
        }

        function deleteChat(chatId, event) {
            event.stopPropagation();
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —á–∞—Ç?')) {
                delete allChats[chatId];
                saveChatsToLocalStorage();
                
                if (currentChatId === chatId) {
                    createNewChat();
                } else {
                    renderChatList();
                }
            }
        }

        function renderChatList() {
            chatList.innerHTML = '';
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º —á–∞—Ç—ã –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
            const sortedChats = Object.entries(allChats)
                .sort((a, b) => b[1].timestamp - a[1].timestamp);
            
            sortedChats.forEach(([chatId, chat]) => {
                const chatItem = document.createElement('div');
                chatItem.classList.add('chat-item');
                if (chatId === currentChatId) {
                    chatItem.classList.add('active');
                }
                
                const preview = chat.messages.find(m => m.role === 'user')?.content || '–ü—É—Å—Ç–æ–π —á–∞—Ç';
                const date = new Date(chat.timestamp);
                const timeStr = date.toLocaleDateString('ru-RU') + ' ' + date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
                
                chatItem.innerHTML = `
                    <div class="chat-item-content">
                        <div class="chat-item-title">${chat.title}</div>
                        <div class="chat-item-preview">${preview.substring(0, 50)}...</div>
                    </div>
                    <div class="chat-item-time">${timeStr}</div>
                    <button class="chat-item-delete" onclick="event.stopPropagation()">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                chatItem.addEventListener('click', () => loadChat(chatId));
                chatItem.querySelector('.chat-item-delete').addEventListener('click', (e) => deleteChat(chatId, e));
                
                chatList.appendChild(chatItem);
            });
        }

        function saveChatsToLocalStorage() {
            localStorage.setItem('vivi_chats', JSON.stringify(allChats));
            renderPinned();
        }

        function loadChatsFromLocalStorage() {
            const saved = localStorage.getItem('vivi_chats');
            if (saved) {
                try {
                    allChats = JSON.parse(saved);
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤:', e);
                    allChats = {};
                }
            }
        }

        // –î–æ–ø. —Ñ—É–Ω–∫—Ü–∏–∏: pin, renderPinned, search, rename, export current
        function pinMessage(messageId) {
            if (!currentChatId || !allChats[currentChatId]) return;
            const msg = messagesById[messageId];
            if (!msg) return;
            allChats[currentChatId].pinned = allChats[currentChatId].pinned || {};
            // Toggle pin (–µ—Å–ª–∏ —É–∂–µ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω ‚Äî –æ—Ç–∫—Ä–µ–ø–ª—è–µ–º)
            if (allChats[currentChatId].pinned[messageId]) {
                delete allChats[currentChatId].pinned[messageId];
            } else {
                allChats[currentChatId].pinned[messageId] = { content: msg.content, timestamp: msg.timestamp, sender: msg.sender };
            }
            saveChatsToLocalStorage();
            renderPinned();
            renderChatList();
        }

        function renderPinned() {
            const pinnedList = document.getElementById('pinned-list');
            if (!pinnedList) return;
            pinnedList.innerHTML = '';
            if (!currentChatId || !allChats[currentChatId]) return;
            const pinned = allChats[currentChatId].pinned || {};
            const ids = Object.keys(pinned);
            if (ids.length === 0) {
                pinnedList.innerHTML = '<div style="font-size:0.85rem;color:#707070;">–ù–µ—Ç –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
                return;
            }
            ids.forEach(id => {
                const p = pinned[id];
                const el = document.createElement('div');
                el.style.display = 'flex';
                el.style.justifyContent = 'space-between';
                el.style.alignItems = 'center';
                el.style.gap = '0.5rem';
                el.style.padding = '0.4rem';
                el.style.borderRadius = '0.5rem';
                el.style.background = '#121226';
                el.style.marginBottom = '0.35rem';
                const txt = document.createElement('div');
                txt.style.fontSize = '0.85rem';
                txt.style.color = '#e0e0e0';
                txt.textContent = (p.sender === 'user' ? '–í—ã: ' : '–í–∏–≤–∏: ') + (p.content?.substring(0, 80) || '');
                const btn = document.createElement('button');
                btn.className = 'sidebar-button';
                btn.innerHTML = '<i class="fas fa-thumbtack"></i>';
                btn.title = '–û—Ç–∫—Ä–µ–ø–∏—Ç—å';
                btn.onclick = (e)=>{ e.stopPropagation(); pinMessage(id); };
                el.appendChild(txt);
                el.appendChild(btn);
                pinnedList.appendChild(el);
            });
        }

        function searchMessages(query) {
            // —Ä–µ–Ω–¥–µ—Ä–∏–º —Ç–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –∑–∞–ø—Ä–æ—Å—É (–ø–æ —Ç–µ–∫—Å—Ç—É)
            const q = String(query || '').trim().toLowerCase();
            const chatHistoryEl = document.getElementById('chat-history');
            if (!chatHistoryEl) return;
            // –µ—Å–ª–∏ –ø—É—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–Ω—ã–π chatHistoryArray
            chatHistoryEl.innerHTML = '';
            if (!q) {
                chatHistoryArray.forEach(msg => addMessage(msg.role, msg.content, msg.type || 'text', msg.fileData || null, msg.filename || null));
                return;
            }
            // —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è
            chatHistoryArray.forEach(msg => {
                if ((msg.content && msg.content.toLowerCase().includes(q)) || (msg.fileData && String(msg.fileData).toLowerCase().includes(q))) {
                    addMessage(msg.role, msg.content, msg.type || 'text', msg.fileData || null, msg.filename || null);
                }
            });
        }

        function renameCurrentChat() {
            if (!currentChatId || !allChats[currentChatId]) return;
            const newTitle = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞:', allChats[currentChatId].title || '');
            if (newTitle && newTitle.trim()) {
                allChats[currentChatId].title = newTitle.trim().substring(0, 80);
                saveChatsToLocalStorage();
                renderChatList();
            }
        }

        function exportCurrentChat() {
            if (!currentChatId || !allChats[currentChatId]) return alert('–ù–µ—Ç —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞.');
            const chat = allChats[currentChatId];
            const dataStr = JSON.stringify({ id: currentChatId, ...chat }, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `vivi_chat_${currentChatId}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        // –£–±—Ä–∞–Ω—ã —Ä–∞–Ω–Ω–∏–µ –ø—Ä–∏–≤—è–∑–∫–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∏ —Ä–∞–Ω–Ω—è—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è.
        // –í–µ—à–∞–µ–º –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º UI —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM:
        document.addEventListener('DOMContentLoaded', () => {
            // –≠–ª–µ–º–µ–Ω—Ç—ã DOM ‚Äî –ø–æ–ª—É—á–∞–µ–º –∑–¥–µ—Å—å, –∫–æ–≥–¥–∞ –æ–Ω–∏ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
            const chatHistory = document.getElementById('chat-history');
            const userInput = document.getElementById('user-input');
            const sendButton = document.getElementById('send-button');
            const loadingIndicator = document.getElementById('loading-indicator');
            const speakLastButton = document.getElementById('speak-last-button');
            const attachButton = document.getElementById('attach-button');
            const hiddenFileInput = document.getElementById('hidden-file-input');
            const chatList = document.getElementById('chat-list');
            const newChatButton = document.getElementById('new-chat-button');
            const clearHistoryButton = document.getElementById('clear-history-button');
            const searchInput = document.getElementById('chat-search-input');
            const searchClear = document.getElementById('search-clear-button');
            const renameBtn = document.getElementById('rename-chat-button');
            const exportCurrentBtn = document.getElementById('export-current-button');

            // –î–µ–ª–∞–µ–º —ç—Ç–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≥–ª–æ–±–∞–ª—å–Ω—ã–º–∏ –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞ (–µ—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∏—Ö)
            window.chatHistory = chatHistory;
            window.userInput = userInput;
            window.sendButton = sendButton;
            window.loadingIndicator = loadingIndicator;
            window.speakLastButton = speakLastButton;
            window.attachButton = attachButton;
            window.hiddenFileInput = hiddenFileInput;
            window.chatList = chatList;
            window.newChatButton = newChatButton;
            window.clearHistoryButton = clearHistoryButton;

            // –ü—Ä–∏–≤—è–∑–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ ‚Äî –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ (createNewChat, sendMessage –∏ –¥—Ä.) —É–∂–µ –æ–±—ä—è–≤–ª–µ–Ω—ã –≤—ã—à–µ
            newChatButton.addEventListener('click', createNewChat);
            clearHistoryButton.addEventListener('click', () => {
                if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–æ–≤? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
                    allChats = {};
                    saveChatsToLocalStorage();
                    createNewChat();
                }
            });
            userInput.addEventListener('input', updateSendButtonState);
            userInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    sendMessage();
                }
            });
            sendButton.addEventListener('click', sendMessage);

            attachButton.addEventListener('click', () => hiddenFileInput.click());

            hiddenFileInput.addEventListener('change', async (event) => {
                // –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫, –æ–±—ä—è–≤–ª–µ–Ω–Ω—ã–π –≤—ã—à–µ –∫–∞–∫ —Ñ—É–Ω–∫—Ü–∏—è
                const file = event.target.files[0];
                if (!file) return;
                // –í—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ—Ç –∂–µ –∫–æ–¥, —á—Ç–æ —É –≤–∞—Å –±—ã–ª –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ change (–∏–ª–∏ –≤—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é, –µ—Å–ª–∏ –æ–Ω–∞ –≤—ã–Ω–µ—Å–µ–Ω–∞)
                addMessage('user', null, 'uploaded_file_url', URL.createObjectURL(file), file.name);
                sendButton.disabled = true;
                attachButton.disabled = true;
                speakLastButton.disabled = true;
                loadingIndicator.style.display = 'block';

                const formData = new FormData();
                formData.append('file', file);
                try {
                    const response = await fetch(`${VIVI_BACKEND_URL}/uploadfile`, { method: 'POST', body: formData });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const result = await response.json();
                    if (result.file_url) {
                        if (result.file_type === 'image') addMessage('vivi', null, 'uploaded_image_url', result.file_url, result.filename);
                        else if (result.file_type === 'video') addMessage('vivi', null, 'uploaded_video_url', result.file_url, result.filename);
                        else addMessage('vivi', null, 'uploaded_file_url', result.file_url, result.filename);
                    }
                    hiddenFileInput.value = '';
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                    addMessage('vivi', `–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª: ${error.message}.`);
                } finally {
                    loadingIndicator.style.display = 'none';
                    updateSendButtonState();
                    speakLastButton.disabled = false;
                    attachButton.disabled = false;
                    chatHistory.scrollTop = chatHistory.scrollHeight;
                }
            });

            speakLastButton.addEventListener('click', () => {
                if (lastViviResponseText) {
                    const utterance = new SpeechSynthesisUtterance(lastViviResponseText);
                    window.speechSynthesis.speak(utterance);
                }
            });

            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const q = e.target.value;
                    searchMessages(q);
                });
            }
            if (searchClear) {
                searchClear.addEventListener('click', () => {
                    const si = document.getElementById('chat-search-input');
                    if (si) { si.value = ''; searchMessages(''); }
                });
            }
            if (renameBtn) renameBtn.addEventListener('click', renameCurrentChat);
            if (exportCurrentBtn) exportCurrentBtn.addEventListener('click', exportCurrentChat);

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–∞—Ç–æ–≤ (–ø–æ—Å–ª–µ –≤—Å–µ—Ö –ø—Ä–∏–≤—è–∑–æ–∫)
            loadChatsFromLocalStorage();
            const chatIds = Object.keys(allChats || {});
            if (chatIds.length > 0) {
                const sorted = chatIds.sort((a,b) => (allChats[b].timestamp || 0) - (allChats[a].timestamp || 0));
                loadChat(sorted[0]);
            } else {
                createNewChat();
            }
            renderChatList();
            updateSendButtonState();

            // –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤, –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ (–µ—Å–ª–∏ –µ—Å—Ç—å)
            renderPinned();
        });


        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
        function addMessage(sender, content, type = 'text', fileData = null, filename = null) {
            messageCounter++;
            const messageId = 'm_' + Date.now() + '_' + Math.random().toString(36).substr(2,6);
            // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            messagesById[messageId] = { sender, content, type, fileData, filename, timestamp: Date.now() };

            const messageWrapper = document.createElement('div');
            messageWrapper.classList.add('message-wrapper');
            messageWrapper.classList.add(sender === 'user' ? 'user-message-wrapper' : 'vivi-message-wrapper');
            messageWrapper.dataset.messageId = messageCounter;
            messageWrapper.dataset.msgid = messageId;

            const messageElement = document.createElement('div');
            messageElement.classList.add('message-bubble');
            messageElement.classList.add(sender === 'user' ? 'user-message' : 'vivi-message');

            if (content && typeof content === 'string') {
                if (type === 'text') {
                    messageElement.textContent = content;
                } else {
                    const textSpan = document.createElement('span');
                    textSpan.textContent = content;
                    messageElement.appendChild(textSpan);
                    messageElement.appendChild(document.createElement('br'));
                }
            }

            if (type === 'image_data' || type === 'gif_data') {
                const img = document.createElement('img');
                img.src = `data:image/${type === 'image_data' ? 'png' : 'gif'};base64,${fileData}`;
                img.alt = '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ/GIF';
                img.classList.add('generated-image');
                messageElement.appendChild(img);
                lastViviResponseText = content || `–Ø —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª–∞ ${type === 'image_data' ? '–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ' : 'GIF-–∞–Ω–∏–º–∞—Ü–∏—é'}.`;
            } else if (type === 'code') {
                if (content && typeof content === 'string') {
                    // –¢–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤—ã—à–µ.
                } else {
                    const defaultTextSpan = document.createElement('span');
                    defaultTextSpan.textContent = '–í–æ—Ç –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π —è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª–∞:';
                    messageElement.appendChild(defaultTextSpan);
                    messageElement.appendChild(document.createElement('br'));
                }
                
                const codeBlock = document.createElement('pre');
                const codeElement = document.createElement('code');
                codeElement.textContent = fileData;
                codeBlock.classList.add('code-display');
                codeBlock.appendChild(codeElement);
                messageElement.appendChild(codeBlock);
                lastViviResponseText = content || '–Ø —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª–∞ –∫–æ–¥.';
            } else if (type === 'uploaded_image_url' || type === 'uploaded_video_url' || type === 'uploaded_file_url') {
                if (!content || typeof content !== 'string') {
                    const defaultTextSpan = document.createElement('span');
                    defaultTextSpan.textContent = `–Ø –ø–æ–ª—É—á–∏–ª–∞ ${filename || (type === 'uploaded_image_url' ? '–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ' : type === 'uploaded_video_url' ? '–≤–∏–¥–µ–æ' : '—Ñ–∞–π–ª')}: `;
                    messageElement.appendChild(defaultTextSpan);
                    messageElement.appendChild(document.createElement('br'));
                }
                if (type === 'uploaded_image_url') {
                    const img = document.createElement('img');
                    img.src = fileData;
                    img.alt = filename || '–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';
                    img.classList.add('uploaded-media');
                    messageElement.appendChild(img);
                } else if (type === 'uploaded_video_url') {
                    const video = document.createElement('video');
                    video.src = fileData;
                    video.controls = true;
                    video.classList.add('uploaded-media');
                    messageElement.appendChild(video);
                } else {
                    const link = document.createElement('a');
                    link.href = fileData;
                    link.target = "_blank";
                    link.textContent = filename || '—Ñ–∞–π–ª';
                    link.style.color = '#87CEEB';
                    link.style.textDecoration = 'underline';
                    messageElement.appendChild(link);
                }
                lastViviResponseText = `–Ø –ø–æ–ª—É—á–∏–ª–∞ ${filename || '—Ñ–∞–π–ª'}.`;
            } else {
                if (sender === 'vivi') {
                    lastViviResponseText = content;
                }
            }

            // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π (–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å, pin)
            const actionsDiv = document.createElement('div');
            actionsDiv.classList.add('message-actions');

            if (sender === 'user') {
                const editButton = document.createElement('button');
                editButton.innerHTML = '<i class="fas fa-edit"></i>';
                editButton.title = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ';
                editButton.onclick = () => editMessage(messageWrapper.dataset.messageId, content);
                actionsDiv.appendChild(editButton);
            } else {
                const copyButton = document.createElement('button');
                copyButton.innerHTML = '<i class="fas fa-copy"></i>';
                copyButton.title = '–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç';
                copyButton.onclick = () => copyMessage(content, messageElement);
                actionsDiv.appendChild(copyButton);
            }

            // –ö–Ω–æ–ø–∫–∞ pin (–¥–ª—è –ª—é–±–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è)
            const pinButton = document.createElement('button');
            pinButton.innerHTML = '<i class="fas fa-thumbtack"></i>';
            pinButton.title = '–ó–∞–∫—Ä–µ–ø–∏—Ç—å/–û—Ç–∫—Ä–µ–ø–∏—Ç—å';
            pinButton.onclick = (e) => { e.stopPropagation(); pinMessage(messageId); };
            actionsDiv.appendChild(pinButton);

            messageWrapper.appendChild(messageElement);
            messageWrapper.appendChild(actionsDiv);
            chatHistory.appendChild(messageWrapper);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è
        function editMessage(messageId, originalContent) {
            userInput.value = originalContent;
            userInput.focus();
            userInput.style.height = 'auto';
            userInput.style.height = (userInput.scrollHeight) + 'px';
            updateSendButtonState();
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
        function copyMessage(content, messageElement) {
            // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º navigator.clipboard, –Ω–æ —Å fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
            if (!navigator.clipboard) {
                console.error('API Clipboard –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ document.execCommand.');
                const textArea = document.createElement('textarea');
                textArea.value = content;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                } catch (err) {
                    console.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç: ', err);
                }
                document.body.removeChild(textArea);
                return;
            }

            navigator.clipboard.writeText(content).then(() => {
                const copiedIndicator = document.createElement('div');
                copiedIndicator.classList.add('copied-message');
                copiedIndicator.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                messageElement.appendChild(copiedIndicator);
                setTimeout(() => {
                    copiedIndicator.style.opacity = '1';
                }, 10);
                setTimeout(() => {
                    copiedIndicator.style.opacity = '0';
                    copiedIndicator.addEventListener('transitionend', () => copiedIndicator.remove());
                }, 1500);
            }).catch(err => {
                console.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç: ', err);
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        async function sendMessage() {
            const userText = userInput.value.trim();
            if (!userText) return;

            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ UI
            addMessage('user', userText);

            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –º–∞—Å—Å–∏–≤ –∏—Å—Ç–æ—Ä–∏–∏
            chatHistoryArray.push({ role: "user", content: userText });

            // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –∏ –æ—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            userInput.value = '';
            userInput.style.height = 'auto';
            updateSendButtonState();
            sendButton.disabled = true;
            attachButton.disabled = true;
            speakLastButton.disabled = true;
            loadingIndicator.style.display = 'block';

            try {
                // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                const payload = {
                    user_prompt: userText,
                    chat_history: chatHistoryArray
                };

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                const response = await fetch(`${VIVI_BACKEND_URL}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
                const responseText = result.response ? result.response.trim() : '';
                const fileData = result.file_data || result.data;
                const fileType = result.file_type || result.type;
                const fileUrl = result.file_url;

                if (responseText) {
                    if (fileUrl) {
                        addMessage('vivi', responseText, fileType, fileUrl, result.filename);
                    } else if (fileData) {
                        addMessage('vivi', responseText, fileType, fileData, result.filename);
                    } else {
                        addMessage('vivi', responseText, 'text');
                    }
                } else if (fileUrl) {
                    addMessage('vivi', null, fileType, fileUrl, result.filename);
                } else {
                    addMessage('vivi', "–ò–∑–≤–∏–Ω–∏—Ç–µ, —è –Ω–µ —Å–º–æ–≥–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑. ", 'text');
                }

                // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –í–∏–≤–∏ –≤ –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—Ä–æ—Å–µ
                chatHistoryArray.push({ role: "vivi", content: responseText });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —á–∞—Ç
                if (currentChatId && allChats[currentChatId]) {
                    allChats[currentChatId].messages = chatHistoryArray;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞ –µ—Å–ª–∏ –æ–Ω –µ—â–µ "–ù–æ–≤—ã–π —á–∞—Ç"
                    if (allChats[currentChatId].title === '–ù–æ–≤—ã–π —á–∞—Ç') {
                        const firstUserMsg = chatHistoryArray.find(m => m.role === 'user');
                        if (firstUserMsg) {
                            allChats[currentChatId].title = firstUserMsg.content.substring(0, 40);
                        }
                    }
                    
                    saveChatsToLocalStorage();
                    renderChatList();
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                addMessage('vivi', `–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç: ${error.message}.`);
            } finally {
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º UI –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                loadingIndicator.style.display = 'none';
                updateSendButtonState();
                speakLastButton.disabled = false;
                attachButton.disabled = false;
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏
        function updateSendButtonState() {
            const userText = userInput.value.trim();
            sendButton.disabled = userText === '';
        }

        // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ/—Å–º–µ–Ω–µ —á–∞—Ç–∞ ‚Äî –æ–±–Ω–æ–≤–ª—è—Ç—å pinned area
        function loadChat(chatId) {
            if (!allChats[chatId]) return;
            
            currentChatId = chatId;
            const chat = allChats[chatId];
            chatHistoryArray = [...chat.messages];
            messageCounter = 0;
            lastViviResponseText = '';
            
            // –û—á–∏—â–∞–µ–º –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º UI
            chatHistory.innerHTML = '';
            chatHistoryArray.forEach(msg => {
                addMessage(msg.role, msg.content);
            });
            
            userInput.value = '';
            updateSendButtonState();
            renderChatList();

            renderPinned();
        }

        // –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —á–∞—Ç–∞ ‚Äî –æ–±–Ω–æ–≤–ª—è—Ç—å pinned area
        function saveChatsToLocalStorage() {
            localStorage.setItem('vivi_chats', JSON.stringify(allChats));
            renderPinned();
        }
    </script>
</body>
</html>
