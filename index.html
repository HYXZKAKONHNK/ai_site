<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í–∏–≤–∏ (V4.5unit) - –í–∞—à –ò–ò –ö–æ–º–ø–∞–Ω—å–æ–Ω</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
            color: #e0e0e0;
            display: flex;
            gap: 1rem;
            min-height: 100vh;
            padding: 1rem;
            box-sizing: border-box;
            overflow: hidden;
        }
        
        .sidebar {
            width: 380px;
            background-color: #1a1a2e;
            border-radius: 1.5rem;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            overflow-y: auto;
            flex-shrink: 0;
        }
        
        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .sidebar-title {
            font-size: 1.35rem;
            font-weight: 700;
            color: #e94560;
            letter-spacing: 0.05em;
        }
        
        .sidebar-button {
            background: none;
            border: none;
            color: #e0e0e0;
            cursor: pointer;
            font-size: 1.2rem;
            transition: color 0.3s ease;
            padding: 0.3rem;
        }
        
        .sidebar-button:hover {
            color: #e94560;
        }
        
        .new-chat-button {
            background-color: #e94560;
            color: white;
            border: none;
            border-radius: 0.8rem;
            padding: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .new-chat-button:hover {
            background-color: #b7384d;
        }
        
        .chat-list {
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .chat-item {
            background-color: #2a2a4a;
            border-radius: 0.8rem;
            padding: 1.15rem;
            cursor: pointer;
            transition: background-color 0.3s ease, border-color 0.3s ease;
            border: 1px solid transparent;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 0.5rem;
        }
        
        .chat-item:hover {
            background-color: #16213e;
            border-color: #e94560;
        }
        
        .chat-item.active {
            background-color: #0f3460;
            border-color: #e94560;
        }
        
        .chat-item-content {
            flex-grow: 1;
            overflow: hidden;
        }
        
        .chat-item-title {
            font-weight: 600;
            color: #e0e0e0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.96rem;
        }
        
        .chat-item-preview {
            font-size: 0.89rem;
            color: #a0a0a0;
            margin-top: 0.3rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .chat-item-time {
            font-size: 0.75rem;
            color: #707070;
            white-space: nowrap;
        }
        
        .chat-item-delete {
            background: none;
            border: none;
            color: #a0a0a0;
            cursor: pointer;
            font-size: 0.9rem;
            padding: 0.2rem;
            opacity: 0;
            transition: opacity 0.3s ease, color 0.3s ease;
        }
        
        .chat-item:hover .chat-item-delete {
            opacity: 1;
        }
        
        .chat-item-delete:hover {
            color: #e94560;
        }
        
        .sidebar-footer {
            border-top: 1px solid #0f3460;
            padding-top: 1rem;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .sidebar-footer button {
            flex: 1;
            background-color: #2a2a4a;
            color: #e0e0e0;
            border: 1px solid #0f3460;
            border-radius: 0.6rem;
            padding: 0.6rem;
            font-size: 0.85rem;
            cursor: pointer;
            transition: background-color 0.3s ease, border-color 0.3s ease;
            min-width: 100px;
        }
        
        .sidebar-footer button:hover {
            background-color: #16213e;
            border-color: #e94560;
            color: #e94560;
        }
        
        .main-content {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .vivi-container {
            background-color: #2a2a4a;
            border-radius: 1.5rem;
            padding: 2.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            max-width: 900px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            max-height: 95vh;
        }
        .chat-history {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .message-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 0.5rem;
        }
        .user-message-wrapper {
            justify-content: flex-end;
        }
        .vivi-message-wrapper {
            justify-content: flex-start;
        }
        .message-bubble {
            max-width: 85%;
            padding: 0.8rem 1.2rem;
            border-radius: 1.2rem;
            line-height: 1.5;
            word-wrap: break-word;
            white-space: pre-wrap;
            position: relative;
        }
        .user-message {
            background-color: #0f3460;
            border-bottom-right-radius: 0.3rem;
        }
        .vivi-message {
            background-color: #16213e;
            border-bottom-left-radius: 0.3rem;
        }
        .message-actions {
            display: flex;
            gap: 0.3rem;
            margin-bottom: 0.2rem;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .message-wrapper:hover .message-actions {
            opacity: 1;
        }
        .message-actions button {
            background: none;
            border: none;
            color: #e0e0e0;
            cursor: pointer;
            font-size: 0.8em;
            padding: 0.2rem;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }
        .message-actions button:hover {
            opacity: 1;
            color: #e94560;
        }
        .copied-message {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #e94560;
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            white-space: nowrap;
            pointer-events: none;
        }
        .input-area {
            display: flex;
            gap: 0.8rem;
            align-items: flex-end;
        }
        .input-area textarea {
            flex-grow: 1;
            background-color: #1a1a2e;
            border: 1px solid #0f3460;
            border-radius: 0.8rem;
            padding: 0.8rem 1rem;
            color: #e0e0e0;
            resize: none;
            min-height: 40px;
            max-height: 150px;
            overflow-y: auto;
        }
        .input-area button {
            background-color: #e94560;
            color: white;
            border-radius: 0.8rem;
            padding: 0.8rem 1.2rem;
            font-weight: 600;
            transition: background-color 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
            min-height: 40px;
            border: none;
            cursor: pointer;
        }
        .input-area button:hover:not(:disabled) {
            background-color: #b7384d;
        }
        .input-area button:disabled {
            background-color: #554a55;
            cursor: not-allowed;
        }
        .header {
            text-align: center;
            font-size: 2.2rem;
            font-weight: 700;
            color: #e94560;
            margin-bottom: 1rem;
            letter-spacing: 0.05em;
        }
        .logo-small {
            width: 30px;
            height: 30px;
            margin-right: 8px;
            vertical-align: middle;
        }
        .loading-indicator {
            display: none;
            text-align: center;
            padding: 1rem;
            color: #e94560;
            font-weight: 600;
        }
        .message-bubble .generated-image,
        .message-bubble .uploaded-media {
            max-width: 100%;
            height: auto;
            display: block;
            margin-top: 0.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .message-bubble .code-display {
            background-color: #1a1a2e;
            color: #00ff00;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-top: 0.5rem;
            font-family: 'Fira Code', 'Consolas', 'monospace';
            white-space: pre-wrap;
            overflow-x: auto;
            border: 1px solid #0f3460;
        }
        
        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: #2a2a4a;
            padding: 2rem;
            border-radius: 1rem;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .modal-header {
            font-size: 1.5rem;
            font-weight: 700;
            color: #e94560;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        
        .modal-input {
            width: 100%;
            background-color: #1a1a2e;
            border: 1px solid #0f3460;
            border-radius: 0.5rem;
            padding: 0.8rem;
            color: #e0e0e0;
            margin-bottom: 1rem;
            box-sizing: border-box;
        }
        
        .modal-button {
            width: 100%;
            background-color: #e94560;
            color: white;
            border: none;
            border-radius: 0.5rem;
            padding: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-bottom: 0.5rem;
        }
        
        .modal-button:hover {
            background-color: #b7384d;
        }
        
        .modal-button.secondary {
            background-color: #2a2a4a;
            border: 1px solid #0f3460;
        }
        
        .modal-button.secondary:hover {
            background-color: #16213e;
            border-color: #e94560;
        }
        
        .error-message {
            color: #ff6b6b;
            font-size: 0.85rem;
            margin-top: 0.5rem;
            text-align: center;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background-color: #2a2a4a;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .user-info-text {
            flex-grow: 1;
            font-size: 0.9rem;
            color: #e0e0e0;
        }
        
        .logout-button {
            background-color: #e94560;
            color: white;
            border: none;
            border-radius: 0.4rem;
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        .logout-button:hover {
            background-color: #b7384d;
        }
        
        .support-button {
            background-color: #4CAF50;
            width: 100%;
        }
        
        .support-button:hover {
            background-color: #45a049;
        }
        
        .support-badge {
            background-color: #e94560;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 0.3rem;
            font-size: 0.75rem;
            margin-left: 0.5rem;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
    <div id="auth-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
            <input type="text" id="auth-username" class="modal-input" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
            <input type="password" id="auth-password" class="modal-input" placeholder="–ü–∞—Ä–æ–ª—å">
            <div id="auth-error" class="error-message"></div>
            <button id="login-button" class="modal-button">–í–æ–π—Ç–∏</button>
            <button id="register-button" class="modal-button secondary">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
        </div>
    </div>

    <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –∏—Å—Ç–æ—Ä–∏–µ–π —á–∞—Ç–æ–≤ -->
    <div class="sidebar">
        <div class="user-info" id="user-info" style="display: none;">
            <div class="user-info-text" id="user-info-text"></div>
            <button class="logout-button" id="logout-button">–í—ã–π—Ç–∏</button>
        </div>
        
        <div class="sidebar-header">
            <div class="sidebar-title">üí¨ –ß–∞—Ç—ã</div>
            <button class="sidebar-button" id="toggle-sidebar" title="–°–≤–µ—Ä–Ω—É—Ç—å">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>
        
        <div class="sidebar-search" style="display:flex;gap:0.5rem;align-items:center;">
            <input id="chat-search-input" placeholder="–ü–æ–∏—Å–∫ –≤ —á–∞—Ç–µ..." style="flex:1;padding:0.5rem;border-radius:0.6rem;border:1px solid #0f3460;background:#121225;color:#e0e0e0;">
            <button id="search-clear-button" title="–û—á–∏—Å—Ç–∏—Ç—å –ø–æ–∏—Å–∫" class="sidebar-button" style="font-size:1rem;">‚úñ</button>
        </div>
        <div id="pinned-area" style="margin-top:0.75rem;">
            <div style="font-size:0.85rem;color:#a0a0a0;margin-bottom:0.4rem;">üìå –ó–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–µ</div>
            <div id="pinned-list"></div>
        </div>
        
        <button class="new-chat-button" id="new-chat-button">
            <i class="fas fa-plus"></i> –ù–æ–≤—ã–π —á–∞—Ç
        </button>
        
        <div class="chat-list" id="chat-list"></div>
        
        <div class="sidebar-footer">
            <button id="support-button" class="support-button" style="flex: 1 1 100%;">
                <i class="fas fa-headset"></i> –¢–µ—Ö. –ø–æ–¥–¥–µ—Ä–∂–∫–∞
            </button>
            <button id="export-current-button" title="–≠–∫—Å–ø–æ—Ä—Ç —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞">
                <i class="fas fa-file-export"></i> –≠–∫—Å–ø–æ—Ä—Ç —á–∞—Ç–∞
            </button>
            <button id="rename-chat-button" title="–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å —á–∞—Ç">
                <i class="fas fa-edit"></i> –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å
            </button>
            <button id="clear-history-button" title="–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é">
                <i class="fas fa-trash"></i> –û—á–∏—Å—Ç–∏—Ç—å
            </button>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç -->
    <div class="main-content">
        <div class="vivi-container">
            <div class="header">
                <img src="/images/Vivi.jpg" alt="–õ–æ–≥–æ—Ç–∏–ø –í–∏–≤–∏" class="logo-small">
                –í–∏–≤–∏ (V4.5unit)
            </div>

            <div class="chat-history" id="chat-history">
                <div class="message-wrapper vivi-message-wrapper">
                    <div class="message-bubble vivi-message">–ü—Ä–∏–≤–µ—Ç! –Ø –í–∏–≤–∏, –≤–∞—à –ò–ò-–∫–æ–º–ø–∞–Ω—å–æ–Ω. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å? üòä</div>
                </div>
            </div>

            <div class="loading-indicator" id="loading-indicator">
                –í–∏–≤–∏ –¥—É–º–∞–µ—Ç... ü§î
            </div>

            <div class="input-area">
                <textarea
                    id="user-input"
                    placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –í–∏–≤–∏..."
                    rows="1"
                ></textarea>
                <button id="attach-button" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª">
                    <i class="fas fa-paperclip"></i>
                </button>
                <input type="file" id="hidden-file-input" style="display: none;">
                <button id="send-button" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ">
                    <i class="fas fa-paper-plane"></i>
                </button>
                <button id="speak-last-button" disabled title="–û–∑–≤—É—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç–≤–µ—Ç">
                    <i class="fas fa-volume-up"></i>
                </button>
            </div>
        </div>
    </div>
    <script>
// URL –±—ç–∫–µ–Ω–¥–∞ –í–∏–≤–∏
const VIVI_BACKEND_URL = "https://lana-hylozoic-malena.ngrok-free.dev";

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let allChats = {};
let chatHistoryArray = [];
let currentChatId = null;
let messageCounter = 0;
let lastViviResponseText = '';
let messagesById = {};
let currentUser = null;
let isSupportMode = false;
let allUsers = {};
let supportMessages = [];

// –≠–ª–µ–º–µ–Ω—Ç—ã DOM
let chatHistory, userInput, sendButton, loadingIndicator, speakLastButton;
let attachButton, hiddenFileInput, chatList, newChatButton, clearHistoryButton;
let authModal, authUsername, authPassword, authError, loginButton, registerButton;
let userInfo, userInfoText, logoutButton, supportButton;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
document.addEventListener('DOMContentLoaded', async () => {
    // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã DOM
    chatHistory = document.getElementById('chat-history');
    userInput = document.getElementById('user-input');
    sendButton = document.getElementById('send-button');
    loadingIndicator = document.getElementById('loading-indicator');
    speakLastButton = document.getElementById('speak-last-button');
    attachButton = document.getElementById('attach-button');
    hiddenFileInput = document.getElementById('hidden-file-input');
    chatList = document.getElementById('chat-list');
    newChatButton = document.getElementById('new-chat-button');
    clearHistoryButton = document.getElementById('clear-history-button');
    
    authModal = document.getElementById('auth-modal');
    authUsername = document.getElementById('auth-username');
    authPassword = document.getElementById('auth-password');
    authError = document.getElementById('auth-error');
    loginButton = document.getElementById('login-button');
    registerButton = document.getElementById('register-button');
    
    userInfo = document.getElementById('user-info');
    userInfoText = document.getElementById('user-info-text');
    logoutButton = document.getElementById('logout-button');
    supportButton = document.getElementById('support-button');
    
    // –ü—Ä–∏–≤—è–∑–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
    newChatButton.addEventListener('click', createNewChat);
    clearHistoryButton.addEventListener('click', () => {
        if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–æ–≤? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
            allChats = {};
            saveChatsToLocalStorage();
            createNewChat();
        }
    });
    
    userInput.addEventListener('input', updateSendButtonState);
    userInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
        }
    });
    
    sendButton.addEventListener('click', sendMessage);
    attachButton.addEventListener('click', () => hiddenFileInput.click());
    
    hiddenFileInput.addEventListener('change', async (event) => {
        const file = event.target.files[0];
        if (!file) return;
        
        addMessage('user', null, 'uploaded_file_url', URL.createObjectURL(file), file.name);
        sendButton.disabled = true;
        attachButton.disabled = true;
        speakLastButton.disabled = true;
        loadingIndicator.style.display = 'block';

        const formData = new FormData();
        formData.append('file', file);
        try {
            const response = await fetch(`${VIVI_BACKEND_URL}/uploadfile`, { method: 'POST', body: formData });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const result = await response.json();
            if (result.file_url) {
                if (result.file_type === 'image') addMessage('vivi', null, 'uploaded_image_url', result.file_url, result.filename);
                else if (result.file_type === 'video') addMessage('vivi', null, 'uploaded_video_url', result.file_url, result.filename);
                else addMessage('vivi', null, 'uploaded_file_url', result.file_url, result.filename);
            }
            hiddenFileInput.value = '';
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
            addMessage('vivi', `–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª: ${error.message}.`);
        } finally {
            loadingIndicator.style.display = 'none';
            updateSendButtonState();
            speakLastButton.disabled = false;
            attachButton.disabled = false;
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
    });
    
    speakLastButton.addEventListener('click', () => {
        if (lastViviResponseText) {
            const utterance = new SpeechSynthesisUtterance(lastViviResponseText);
            window.speechSynthesis.speak(utterance);
        }
    });
    
    const searchInput = document.getElementById('chat-search-input');
    const searchClear = document.getElementById('search-clear-button');
    const renameBtn = document.getElementById('rename-chat-button');
    const exportCurrentBtn = document.getElementById('export-current-button');
    
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            const q = e.target.value;
            searchMessages(q);
        });
    }
    if (searchClear) {
        searchClear.addEventListener('click', () => {
            const si = document.getElementById('chat-search-input');
            if (si) { si.value = ''; searchMessages(''); }
        });
    }
    if (renameBtn) renameBtn.addEventListener('click', renameCurrentChat);
    if (exportCurrentBtn) exportCurrentBtn.addEventListener('click', exportCurrentChat);
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    loginButton.addEventListener('click', handleLogin);
    registerButton.addEventListener('click', handleRegister);
    logoutButton.addEventListener('click', handleLogout);
    supportButton.addEventListener('click', openSupportChat);
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Å—Å–∏–∏
    checkSession();
});

// –§—É–Ω–∫—Ü–∏–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (localStorage)
function checkSession() {
    loadUsersFromLocalStorage();
    loadSupportMessagesFromLocalStorage();
    
    const savedUser = localStorage.getItem('vivi_current_user');
    
    if (savedUser) {
        try {
            currentUser = JSON.parse(savedUser);
            showMainInterface();
            loadChatsFromLocalStorage();
            const chatIds = Object.keys(allChats || {});
            if (chatIds.length > 0) {
                const sorted = chatIds.sort((a,b) => (allChats[b].timestamp || 0) - (allChats[a].timestamp || 0));
                loadChat(sorted[0]);
            } else {
                createNewChat();
            }
            renderChatList();
            updateSendButtonState();
            renderPinned();
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', e);
            showAuthModal();
        }
    } else {
        showAuthModal();
    }
}

function showAuthModal() {
    authModal.style.display = 'flex';
    userInfo.style.display = 'none';
}

function showMainInterface() {
    authModal.style.display = 'none';
    userInfo.style.display = 'flex';
    
    const username = currentUser.username;
    userInfoText.textContent = `üë§ ${username}`;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∏
    if (username === 'Privet_53') {
        userInfoText.innerHTML += '<span class="support-badge">ADMIN</span>';
    }
}

function handleLogin() {
    const username = authUsername.value.trim();
    const password = authPassword.value.trim();
    
    if (!username || !password) {
        authError.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è';
        return;
    }
    
    authError.textContent = '';
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if (!allUsers[username]) {
        authError.textContent = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω';
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–æ–ª—å
    if (allUsers[username].password !== password) {
        authError.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å';
        return;
    }
    
    currentUser = {
        id: allUsers[username].id,
        username: username
    };
    
    localStorage.setItem('vivi_current_user', JSON.stringify(currentUser));
    
    showMainInterface();
    loadChatsFromLocalStorage();
    createNewChat();
    renderChatList();
}

function handleRegister() {
    const username = authUsername.value.trim();
    const password = authPassword.value.trim();
    
    if (!username || !password) {
        authError.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è';
        return;
    }
    
    if (password.length < 6) {
        authError.textContent = '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤';
        return;
    }
    
    authError.textContent = '';
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π username
    if (allUsers[username]) {
        authError.textContent = '–≠—Ç–æ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–∂–µ –∑–∞–Ω—è—Ç–æ';
        return;
    }
    
    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    
    allUsers[username] = {
        id: userId,
        username: username,
        password: password,
        createdAt: Date.now()
    };
    
    saveUsersToLocalStorage();
    
    currentUser = {
        id: userId,
        username: username
    };
    
    localStorage.setItem('vivi_current_user', JSON.stringify(currentUser));
    
    showMainInterface();
    createNewChat();
    renderChatList();
}

function handleLogout() {
    localStorage.removeItem('vivi_current_user');
    currentUser = null;
    allChats = {};
    chatHistoryArray = [];
    currentChatId = null;
    isSupportMode = false;
    showAuthModal();
    authUsername.value = '';
    authPassword.value = '';
    authError.textContent = '';
}

function loadUsersFromLocalStorage() {
    const saved = localStorage.getItem('vivi_all_users');
    if (saved) {
        try {
            allUsers = JSON.parse(saved);
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', e);
            allUsers = {};
        }
    }
}

function saveUsersToLocalStorage() {
    localStorage.setItem('vivi_all_users', JSON.stringify(allUsers));
}

function loadSupportMessagesFromLocalStorage() {
    const saved = localStorage.getItem('vivi_support_messages');
    if (saved) {
        try {
            supportMessages = JSON.parse(saved);
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏:', e);
            supportMessages = [];
        }
    }
}

function saveSupportMessagesToLocalStorage() {
    localStorage.setItem('vivi_support_messages', JSON.stringify(supportMessages));
}

// –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞ —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∏
function openSupportChat() {
    if (!currentUser) return;
    
    isSupportMode = true;
    currentChatId = 'support_chat';
    chatHistoryArray = [];
    messageCounter = 0;
    lastViviResponseText = '';
    
    chatHistory.innerHTML = '';
    userInput.value = '';
    
    const username = currentUser.username;
    
    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - Privet_53, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∏
    if (username === 'Privet_53') {
        addMessage('vivi', '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ø–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∏! –ó–¥–µ—Å—å –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.');
        
        if (supportMessages.length > 0) {
            supportMessages.forEach(msg => {
                const senderName = msg.username;
                const role = msg.isAdmin ? 'vivi' : 'user';
                const content = `[${senderName}]: ${msg.message}`;
                addMessage(role, content);
            });
        } else {
            addMessage('vivi', '–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.');
        }
    } else {
        // –û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
        addMessage('vivi', '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É! –û–ø–∏—à–∏—Ç–µ –≤–∞—à—É –ø—Ä–æ–±–ª–µ–º—É, –∏ –º—ã –ø–æ—Å—Ç–∞—Ä–∞–µ–º—Å—è –ø–æ–º–æ—á—å.');
        
        const userMessages = supportMessages.filter(msg => msg.userId === currentUser.id);
        
        if (userMessages.length > 0) {
            userMessages.forEach(msg => {
                const role = msg.isAdmin ? 'vivi' : 'user';
                addMessage(role, msg.message);
            });
        }
    }
    
    updateSendButtonState();
}

// –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —á–∞—Ç–∞–º–∏
function generateChatId() {
    return 'chat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

function createNewChat() {
    if (isSupportMode) {
        isSupportMode = false;
    }
    
    currentChatId = generateChatId();
    chatHistoryArray = [
        { role: "vivi", content: "–ü—Ä–∏–≤–µ—Ç! –Ø –í–∏–≤–∏, –≤–∞—à –ò–ò-–∫–æ–º–ø–∞–Ω—å–æ–Ω. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å? üòä" }
    ];
    allChats[currentChatId] = {
        messages: [...chatHistoryArray],
        title: '–ù–æ–≤—ã–π —á–∞—Ç',
        timestamp: new Date().getTime()
    };
    messageCounter = 0;
    lastViviResponseText = '';
    
    chatHistory.innerHTML = '';
    userInput.value = '';
    addMessage('vivi', "–ü—Ä–∏–≤–µ—Ç! –Ø –í–∏–≤–∏, –≤–∞—à –ò–ò-–∫–æ–º–ø–∞–Ω—å–æ–Ω. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å? üòä");
    
    saveChatsToLocalStorage();
    renderChatList();
    updateSendButtonState();
}

function loadChat(chatId) {
    if (!allChats[chatId]) return;
    
    isSupportMode = false;
    currentChatId = chatId;
    const chat = allChats[chatId];
    chatHistoryArray = [...chat.messages];
    messageCounter = 0;
    lastViviResponseText = '';
    
    chatHistory.innerHTML = '';
    chatHistoryArray.forEach(msg => {
        addMessage(msg.role, msg.content);
    });
    
    userInput.value = '';
    updateSendButtonState();
    renderChatList();
    renderPinned();
}

function deleteChat(chatId, event) {
    event.stopPropagation();
    if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —á–∞—Ç?')) {
        delete allChats[chatId];
        saveChatsToLocalStorage();
        
        if (currentChatId === chatId) {
            createNewChat();
        } else {
            renderChatList();
        }
    }
}

function renderChatList() {
    chatList.innerHTML = '';
    
    const sortedChats = Object.entries(allChats)
        .sort((a, b) => b[1].timestamp - a[1].timestamp);
    
    sortedChats.forEach(([chatId, chat]) => {
        const chatItem = document.createElement('div');
        chatItem.classList.add('chat-item');
        if (chatId === currentChatId && !isSupportMode) {
            chatItem.classList.add('active');
        }
        
        const preview = chat.messages.find(m => m.role === 'user')?.content || '–ü—É—Å—Ç–æ–π —á–∞—Ç';
        const date = new Date(chat.timestamp);
        const timeStr = date.toLocaleDateString('ru-RU') + ' ' + date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
        
        chatItem.innerHTML = `
            <div class="chat-item-content">
                <div class="chat-item-title">${chat.title}</div>
                <div class="chat-item-preview">${preview.substring(0, 50)}...</div>
            </div>
            <div class="chat-item-time">${timeStr}</div>
            <button class="chat-item-delete" onclick="event.stopPropagation()">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        chatItem.addEventListener('click', () => loadChat(chatId));
        chatItem.querySelector('.chat-item-delete').addEventListener('click', (e) => deleteChat(chatId, e));
        
        chatList.appendChild(chatItem);
    });
}

function saveChatsToLocalStorage() {
    if (!currentUser) return;
    const storageKey = `vivi_chats_${currentUser.id}`;
    localStorage.setItem(storageKey, JSON.stringify(allChats));
    renderPinned();
}

function loadChatsFromLocalStorage() {
    if (!currentUser) return;
    const storageKey = `vivi_chats_${currentUser.id}`;
    const saved = localStorage.getItem(storageKey);
    if (saved) {
        try {
            allChats = JSON.parse(saved);
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤:', e);
            allChats = {};
        }
    }
}

function pinMessage(messageId) {
    if (!currentChatId || !allChats[currentChatId]) return;
    const msg = messagesById[messageId];
    if (!msg) return;
    allChats[currentChatId].pinned = allChats[currentChatId].pinned || {};
    if (allChats[currentChatId].pinned[messageId]) {
        delete allChats[currentChatId].pinned[messageId];
    } else {
        allChats[currentChatId].pinned[messageId] = { content: msg.content, timestamp: msg.timestamp, sender: msg.sender };
    }
    saveChatsToLocalStorage();
    renderPinned();
    renderChatList();
}

function renderPinned() {
    const pinnedList = document.getElementById('pinned-list');
    if (!pinnedList) return;
    pinnedList.innerHTML = '';
    if (!currentChatId || !allChats[currentChatId] || isSupportMode) return;
    const pinned = allChats[currentChatId].pinned || {};
    const ids = Object.keys(pinned);
    if (ids.length === 0) {
        pinnedList.innerHTML = '<div style="font-size:0.85rem;color:#707070;">–ù–µ—Ç –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
        return;
    }
    ids.forEach(id => {
        const p = pinned[id];
        const el = document.createElement('div');
        el.style.display = 'flex';
        el.style.justifyContent = 'space-between';
        el.style.alignItems = 'center';
        el.style.gap = '0.5rem';
        el.style.padding = '0.4rem';
        el.style.borderRadius = '0.5rem';
        el.style.background = '#121226';
        el.style.marginBottom = '0.35rem';
        const txt = document.createElement('div');
        txt.style.fontSize = '0.85rem';
        txt.style.color = '#e0e0e0';
        txt.textContent = (p.sender === 'user' ? '–í—ã: ' : '–í–∏–≤–∏: ') + (p.content?.substring(0, 80) || '');
        const btn = document.createElement('button');
        btn.className = 'sidebar-button';
        btn.innerHTML = '<i class="fas fa-thumbtack"></i>';
        btn.title = '–û—Ç–∫—Ä–µ–ø–∏—Ç—å';
        btn.onclick = (e)=>{ e.stopPropagation(); pinMessage(id); };
        el.appendChild(txt);
        el.appendChild(btn);
        pinnedList.appendChild(el);
    });
}

function searchMessages(query) {
    const q = String(query || '').trim().toLowerCase();
    const chatHistoryEl = document.getElementById('chat-history');
    if (!chatHistoryEl) return;
    chatHistoryEl.innerHTML = '';
    if (!q) {
        chatHistoryArray.forEach(msg => addMessage(msg.role, msg.content, msg.type || 'text', msg.fileData || null, msg.filename || null));
        return;
    }
    chatHistoryArray.forEach(msg => {
        if ((msg.content && msg.content.toLowerCase().includes(q)) || (msg.fileData && String(msg.fileData).toLowerCase().includes(q))) {
            addMessage(msg.role, msg.content, msg.type || 'text', msg.fileData || null, msg.filename || null);
        }
    });
}

function renameCurrentChat() {
    if (!currentChatId || !allChats[currentChatId] || isSupportMode) return;
    const newTitle = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞:', allChats[currentChatId].title || '');
    if (newTitle && newTitle.trim()) {
        allChats[currentChatId].title = newTitle.trim().substring(0, 80);
        saveChatsToLocalStorage();
        renderChatList();
    }
}

function exportCurrentChat() {
    if (!currentChatId || !allChats[currentChatId]) return alert('–ù–µ—Ç —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞.');
    const chat = allChats[currentChatId];
    const dataStr = JSON.stringify({ id: currentChatId, ...chat }, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `vivi_chat_${currentChatId}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}

function addMessage(sender, content, type = 'text', fileData = null, filename = null) {
    messageCounter++;
    const messageId = 'm_' + Date.now() + '_' + Math.random().toString(36).substr(2,6);
    messagesById[messageId] = { sender, content, type, fileData, filename, timestamp: Date.now() };

    const messageWrapper = document.createElement('div');
    messageWrapper.classList.add('message-wrapper');
    messageWrapper.classList.add(sender === 'user' ? 'user-message-wrapper' : 'vivi-message-wrapper');
    messageWrapper.dataset.messageId = messageCounter;
    messageWrapper.dataset.msgid = messageId;

    const messageElement = document.createElement('div');
    messageElement.classList.add('message-bubble');
    messageElement.classList.add(sender === 'user' ? 'user-message' : 'vivi-message');

    if (content && typeof content === 'string') {
        if (type === 'text') {
            messageElement.textContent = content;
        } else {
            const textSpan = document.createElement('span');
            textSpan.textContent = content;
            messageElement.appendChild(textSpan);
            messageElement.appendChild(document.createElement('br'));
        }
    }

    if (type === 'image_data' || type === 'gif_data') {
        const img = document.createElement('img');
        img.src = `data:image/${type === 'image_data' ? 'png' : 'gif'};base64,${fileData}`;
        img.alt = '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ/GIF';
        img.classList.add('generated-image');
        messageElement.appendChild(img);
        lastViviResponseText = content || `–Ø —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª–∞ ${type === 'image_data' ? '–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ' : 'GIF-–∞–Ω–∏–º–∞—Ü–∏—é'}.`;
    } else if (type === 'code') {
        if (content && typeof content === 'string') {
        } else {
            const defaultTextSpan = document.createElement('span');
            defaultTextSpan.textContent = '–í–æ—Ç –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π —è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª–∞:';
            messageElement.appendChild(defaultTextSpan);
            messageElement.appendChild(document.createElement('br'));
        }
        
        const codeBlock = document.createElement('pre');
        const codeElement = document.createElement('code');
        codeElement.textContent = fileData;
        codeBlock.classList.add('code-display');
        codeBlock.appendChild(codeElement);
        messageElement.appendChild(codeBlock);
        lastViviResponseText = content || '–Ø —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª–∞ –∫–æ–¥.';
    } else if (type === 'uploaded_image_url' || type === 'uploaded_video_url' || type === 'uploaded_file_url') {
        if (!content || typeof content !== 'string') {
            const defaultTextSpan = document.createElement('span');
            defaultTextSpan.textContent = `–Ø –ø–æ–ª—É—á–∏–ª–∞ ${filename || (type === 'uploaded_image_url' ? '–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ' : type === 'uploaded_video_url' ? '–≤–∏–¥–µ–æ' : '—Ñ–∞–π–ª')}: `;
            messageElement.appendChild(defaultTextSpan);
            messageElement.appendChild(document.createElement('br'));
        }
        if (type === 'uploaded_image_url') {
            const img = document.createElement('img');
            img.src = fileData;
            img.alt = filename || '–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ';
            img.classList.add('uploaded-media');
            messageElement.appendChild(img);
        } else if (type === 'uploaded_video_url') {
            const video = document.createElement('video');
            video.src = fileData;
            video.controls = true;
            video.classList.add('uploaded-media');
            messageElement.appendChild(video);
        } else {
            const link = document.createElement('a');
            link.href = fileData;
            link.target = "_blank";
            link.textContent = filename || '—Ñ–∞–π–ª';
            link.style.color = '#87CEEB';
            link.style.textDecoration = 'underline';
            messageElement.appendChild(link);
        }
        lastViviResponseText = `–Ø –ø–æ–ª—É—á–∏–ª–∞ ${filename || '—Ñ–∞–π–ª'}.`;
    } else {
        if (sender === 'vivi') {
            lastViviResponseText = content;
        }
    }

    const actionsDiv = document.createElement('div');
    actionsDiv.classList.add('message-actions');

    if (sender === 'user') {
        const editButton = document.createElement('button');
        editButton.innerHTML = '<i class="fas fa-edit"></i>';
        editButton.title = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ';
        editButton.onclick = () => editMessage(messageWrapper.dataset.messageId, content);
        actionsDiv.appendChild(editButton);
    } else {
        const copyButton = document.createElement('button');
        copyButton.innerHTML = '<i class="fas fa-copy"></i>';
        copyButton.title = '–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç';
        copyButton.onclick = () => copyMessage(content, messageElement);
        actionsDiv.appendChild(copyButton);
    }

    if (!isSupportMode) {
        const pinButton = document.createElement('button');
        pinButton.innerHTML = '<i class="fas fa-thumbtack"></i>';
        pinButton.title = '–ó–∞–∫—Ä–µ–ø–∏—Ç—å/–û—Ç–∫—Ä–µ–ø–∏—Ç—å';
        pinButton.onclick = (e) => { e.stopPropagation(); pinMessage(messageId); };
        actionsDiv.appendChild(pinButton);
    }

    messageWrapper.appendChild(messageElement);
    messageWrapper.appendChild(actionsDiv);
    chatHistory.appendChild(messageWrapper);
    chatHistory.scrollTop = chatHistory.scrollHeight;
}

function editMessage(messageId, originalContent) {
    userInput.value = originalContent;
    userInput.focus();
    userInput.style.height = 'auto';
    userInput.style.height = (userInput.scrollHeight) + 'px';
    updateSendButtonState();
}

function copyMessage(content, messageElement) {
    if (!navigator.clipboard) {
        console.error('API Clipboard –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ document.execCommand.');
        const textArea = document.createElement('textarea');
        textArea.value = content;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            document.execCommand('copy');
        } catch (err) {
            console.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç: ', err);
        }
        document.body.removeChild(textArea);
        return;
    }

    navigator.clipboard.writeText(content).then(() => {
        const copiedIndicator = document.createElement('div');
        copiedIndicator.classList.add('copied-message');
        copiedIndicator.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
        messageElement.appendChild(copiedIndicator);
        setTimeout(() => {
            copiedIndicator.style.opacity = '1';
        }, 10);
        setTimeout(() => {
            copiedIndicator.style.opacity = '0';
            copiedIndicator.addEventListener('transitionend', () => copiedIndicator.remove());
        }, 1500);
    }).catch(err => {
        console.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç: ', err);
    });
}

async function sendMessage() {
    const userText = userInput.value.trim();
    if (!userText) return;

    addMessage('user', userText);

    if (isSupportMode) {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ localStorage —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∏
        const username = currentUser.username;
        const isAdmin = username === 'Privet_53';
        
        const newMessage = {
            id: 'msg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
            userId: currentUser.id,
            username: username,
            message: userText,
            isAdmin: isAdmin,
            timestamp: Date.now()
        };
        
        supportMessages.push(newMessage);
        saveSupportMessagesToLocalStorage();
        
        if (isAdmin) {
            addMessage('vivi', '–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.');
        } else {
            addMessage('vivi', '–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Ç–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∏ –æ—Ç–≤–µ—Ç–∏—Ç –≤–∞–º –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.');
        }
        
        userInput.value = '';
        updateSendButtonState();
        chatHistory.scrollTop = chatHistory.scrollHeight;
        return;
    }

    chatHistoryArray.push({ role: "user", content: userText });

    userInput.value = '';
    userInput.style.height = 'auto';
    updateSendButtonState();
    sendButton.disabled = true;
    attachButton.disabled = true;
    speakLastButton.disabled = true;
    loadingIndicator.style.display = 'block';

    try {
        const payload = {
            user_prompt: userText,
            chat_history: chatHistoryArray
        };

        const response = await fetch(`${VIVI_BACKEND_URL}/chat`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        
        const responseText = result.response ? result.response.trim() : '';
        const fileData = result.file_data || result.data;
        const fileType = result.file_type || result.type;
        const fileUrl = result.file_url;

        if (responseText) {
            if (fileUrl) {
                addMessage('vivi', responseText, fileType, fileUrl, result.filename);
            } else if (fileData) {
                addMessage('vivi', responseText, fileType, fileData, result.filename);
            } else {
                addMessage('vivi', responseText, 'text');
            }
        } else if (fileUrl) {
            addMessage('vivi', null, fileType, fileUrl, result.filename);
        } else {
            addMessage('vivi', "–ò–∑–≤–∏–Ω–∏—Ç–µ, —è –Ω–µ —Å–º–æ–≥–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑. ", 'text');
        }

        chatHistoryArray.push({ role: "vivi", content: responseText });
        
        if (currentChatId && allChats[currentChatId]) {
            allChats[currentChatId].messages = chatHistoryArray;
            
            if (allChats[currentChatId].title === '–ù–æ–≤—ã–π —á–∞—Ç') {
                const firstUserMsg = chatHistoryArray.find(m => m.role === 'user');
                if (firstUserMsg) {
                    allChats[currentChatId].title = firstUserMsg.content.substring(0, 40);
                }
            }
            
            saveChatsToLocalStorage();
            renderChatList();
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        addMessage('vivi', `–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç: ${error.message}.`);
    } finally {
        loadingIndicator.style.display = 'none';
        updateSendButtonState();
        speakLastButton.disabled = false;
        attachButton.disabled = false;
        chatHistory.scrollTop = chatHistory.scrollHeight;
    }
}

function updateSendButtonState() {
    const userText = userInput.value.trim();
    sendButton.disabled = userText === '';
}
    </script>
</body>
</html>